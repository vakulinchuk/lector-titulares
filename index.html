<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi Lector de Titulares</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:16px; background:#f7f7f8; color:#111; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    input[type="text"]{ padding:8px; font-size:15px; width:100%; box-sizing:border-box; }
    #feeds { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    button{ padding:8px 10px; font-size:14px; cursor:pointer; }
    .card{ background:white; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); margin-bottom:8px; }
    .meta{ font-size:13px; color:#666; margin-bottom:6px; }
    .title{ font-weight:600; margin-bottom:6px; }
    small.badge{ background:#eef; color:#124; padding:3px 6px; border-radius:999px; margin-left:6px; font-weight:600; }
    #controls{ display:flex; gap:8px; }
    #newFeed{ width:340px; max-width:60vw; }
    footer{ margin-top:14px; font-size:13px; color:#666; }
  </style>
</head>
<body>
  <header>
    <div style="flex:1">
      <h2 style="margin:0 0 6px 0">Mi Lector de Titulares</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="filter" type="text" placeholder="Filtrar por palabra clave (ej: corrupción, Ucrania, Zelensky)"/>
        <div id="controls">
          <input id="newFeed" type="text" placeholder="Añadir feed RSS (URL)" />
          <button id="addFeedBtn">Añadir</button>
          <button id="refreshBtn">Actualizar</button>
        </div>
      </div>
    </div>
  </header>

  <div id="feeds"></div>
  <div id="list"></div>

  <footer>
    <div>Notas: usa feeds RSS públicos. Si una web tiene paywall, no mostrará contenido completo.</div>
  </footer>

  <script>
  // Lista inicial de feeds (puedes editarla)
  const defaultFeeds = [
    "https://feeds.bbci.co.uk/news/rss.xml",
    "https://www.reutersagency.com/feed/?best-regions=world&post_type=best",
    "https://elpais.com/rss/feed.html?feedId=1022"
  ];

  // Usamos AllOrigins para evitar problemas CORS (para prototipo)
  function proxyUrl(url){
    return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
  }

  // Guardar/leer feeds en localStorage para que persistan entre sesiones
  function getSavedFeeds(){
    const s = localStorage.getItem('my_feeds_v1');
    try{ return s ? JSON.parse(s) : defaultFeeds; } catch(e){ return defaultFeeds; }
  }
  function saveFeeds(list){ localStorage.setItem('my_feeds_v1', JSON.stringify(list)); renderFeedButtons(); }

  const feedsContainer = document.getElementById('feeds');
  const listEl = document.getElementById('list');
  const filterInput = document.getElementById('filter');
  const addFeedBtn = document.getElementById('addFeedBtn');
  const newFeedInput = document.getElementById('newFeed');
  const refreshBtn = document.getElementById('refreshBtn');

  let feeds = getSavedFeeds();
  let articles = []; // {title, link, date, source, description}

  function renderFeedButtons(){
    feedsContainer.innerHTML = '';
    feeds.forEach((f, i) => {
      const btn = document.createElement('button');
      btn.textContent = (new URL(f).hostname).replace('www.','');
      btn.title = f;
      btn.onclick = () => { fetchFeed(f); };
      const del = document.createElement('button');
      del.textContent = '✕';
      del.style.background='transparent';
      del.onclick = (e)=>{ e.stopPropagation(); feeds.splice(i,1); saveFeeds(feeds); };
      const wrap = document.createElement('div');
      wrap.style.display='inline-flex';
      wrap.style.alignItems='center';
      wrap.style.gap='6px';
      wrap.appendChild(btn); wrap.appendChild(del);
      feedsContainer.appendChild(wrap);
    });
  }

  // Parsear XML del RSS y extraer items
  function parseRss(xmlStr, sourceUrl){
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlStr, "application/xml");
    const items = Array.from(doc.querySelectorAll('item')).slice(0,25);
    const feedTitleEl = doc.querySelector('channel > title');
    const source = feedTitleEl ? feedTitleEl.textContent : (new URL(sourceUrl).hostname);
    const parsed = items.map(it => {
      const title = it.querySelector('title')?.textContent || 'Sin título';
      const link = it.querySelector('link')?.textContent || it.querySelector('guid')?.textContent || '';
      const desc = it.querySelector('description')?.textContent || it.querySelector('content\\:encoded')?.textContent || '';
      const pub = it.querySelector('pubDate')?.textContent || '';
      return { title, link, description: stripHtml(desc), date: pub, source };
    });
    return parsed;
  }

  // limpiar html básico
  function stripHtml(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = html || '';
    return tmp.textContent || tmp.innerText || '';
  }

  // Mostrar artículos (aplica filtro por palabra clave)
  function renderArticles(){
    const q = filterInput.value.trim().toLowerCase();
    const filtered = articles.filter(a => {
      if(!q) return true;
      return (a.title + ' ' + a.description + ' ' + a.source).toLowerCase().includes(q);
    });
    listEl.innerHTML = '';
    if(filtered.length === 0){
      listEl.innerHTML = '<div class="card">No hay resultados.</div>';
      return;
    }
    filtered.forEach(a => {
      const card = document.createElement('div'); card.className='card';
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<strong>${a.source}</strong> <small style="margin-left:8px">${a.date? a.date : ''}</small>`;
      const title = document.createElement('div'); title.className='title';
      const link = document.createElement('a'); link.textContent = a.title; link.href = a.link; link.target = '_blank'; link.rel='noopener';
      title.appendChild(link);
      const desc = document.createElement('div'); desc.textContent = a.description;
      card.appendChild(meta); card.appendChild(title); card.appendChild(desc);
      listEl.appendChild(card);
    });
  }

  // Fetch de un feed y añadir artículos
  async function fetchFeed(url){
    try {
      const res = await fetch(proxyUrl(url));
      if(!res.ok) throw new Error('Error al obtener feed');
      const text = await res.text();
      const parsed = parseRss(text, url);
      // combinar evitando duplicados por link
      const map = new Map(articles.map(a => [a.link || a.title, a]));
      parsed.forEach(p => map.set(p.link || p.title, p));
      articles = Array.from(map.values()).sort((a,b)=> (new Date(b.date) - new Date(a.date)));
      renderArticles();
    } catch(err){
      alert('Error cargando feed: ' + url + '\n' + err.message);
    }
  }

  // Cargar todos los feeds
  async function loadAllFeeds(){
    articles = [];
    renderArticles();
    for(const f of feeds){
      await fetchFeed(f);
    }
  }

  // Eventos UI
  addFeedBtn.onclick = ()=>{
    const val = newFeedInput.value.trim();
    if(!val) return alert('Introduce la URL del feed RSS');
    if(!val.startsWith('http')) return alert('Introduce una URL válida (empieza por http...)');
    feeds.unshift(val);
    saveFeeds(feeds);
    newFeedInput.value = '';
    loadAllFeeds();
  };

  refreshBtn.onclick = ()=> loadAllFeeds();
  filterInput.oninput = ()=> renderArticles();

  // inicializar
  renderFeedButtons();
  loadAllFeeds();
  </script>
</body>
</html>
